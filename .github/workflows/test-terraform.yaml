---
name: Test Terraform
on:
  workflow_dispatch:
    inputs:
      image-version:
        type: string
        default: eu.gcr.io/stuttgart-things/sthings-terraform:1.7.5
        required: false
      runs-on:
        type: string
        required: false
        default: ghr-aws-ec2-vm-sthings-cicd
      #environment-name:
      #  type: string
      #  required: true
      #  default: k8s

jobs:
  Test-Aws-Connection:
    runs-on: ${{ inputs.runs-on }} #ghr-aws-ec2-vm-sthings-cicd
    container:
      image: ${{ inputs.image-version }} #eu.gcr.io/stuttgart-things/sthings-terraform:1.7.5
    environment: k8s
    env:
      AWS_CONFIG_DIR: ~/.aws
    continue-on-error: false
    steps:
      - run: |
          terraform --version
          aws --version
      - name: create credentials file
        run: |
          mkdir -p ${AWS_CONFIG_DIR}
          aws configure list
          echo ${{ secrets.AWS_CONFIG }} | base64 -d > ${AWS_CONFIG_DIR}/credentials
          echo ${{ secrets.AWS_REGION }} | base64 -d > ${AWS_CONFIG_DIR}/config
          aws configure list
          
      - name: view the content credentials file
        run: |
          cat ${AWS_CONFIG_DIR}/credentials
          aws configure list
      - name: Get account details
        run: aws sts get-caller-identity
        
          
